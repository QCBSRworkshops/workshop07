<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 10 Structure in dataset | Workshop 7: Linear and generalized linear mixed models (LMM and GLMM)</title>
  <meta name="description" content="Linear and generalized linear mixed models (LMM and GLMM)" />
  <meta name="generator" content="bookdown 0.21 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 10 Structure in dataset | Workshop 7: Linear and generalized linear mixed models (LMM and GLMM)" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://github.com/qcbsRworkshops/" />
  <meta property="og:image" content="https://github.com/qcbsRworkshops/assets/images/logo/csbq_logo_accueil.png" />
  <meta property="og:description" content="Linear and generalized linear mixed models (LMM and GLMM)" />
  <meta name="github-repo" content="qcbsRworkshops/workshop09" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 10 Structure in dataset | Workshop 7: Linear and generalized linear mixed models (LMM and GLMM)" />
  
  <meta name="twitter:description" content="Linear and generalized linear mixed models (LMM and GLMM)" />
  <meta name="twitter:image" content="https://github.com/qcbsRworkshops/assets/images/logo/csbq_logo_accueil.png" />

<meta name="author" content="Developed and maintained by the contributors of the QCBS R Workshop Series" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  <link rel="shortcut icon" href="assets/images/favicon.ico" type="image/x-icon" />
<link rel="prev" href="generalized-linear-mixed-models-glmms.html"/>
<link rel="next" href="random-intercepts.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  background-color: #f8f8f8; }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #c4a000; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #000000; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #000000; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #000000; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="assets/qcbs-style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="toc-logo"><a href="./"><img src="assets/images/csbq_logo_gray_accueil.png"></a></li>
<link rel="icon" type="image/png" href="assets/images/favicon.ico"/>

<li class="divider"></li>
<li class="part"><span><b>QCBS R Workshop Series</b></span></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a><ul>
<li class="chapter" data-level="0.1" data-path="index.html"><a href="index.html#code-of-conduct"><i class="fa fa-check"></i><b>0.1</b> Code of conduct</a><ul>
<li class="chapter" data-level="0.1.1" data-path="index.html"><a href="index.html#expected-behaviour"><i class="fa fa-check"></i><b>0.1.1</b> Expected behaviour</a></li>
<li class="chapter" data-level="0.1.2" data-path="index.html"><a href="index.html#unacceptable-behaviour"><i class="fa fa-check"></i><b>0.1.2</b> Unacceptable behaviour</a></li>
</ul></li>
<li class="chapter" data-level="0.2" data-path="index.html"><a href="index.html#contributors"><i class="fa fa-check"></i><b>0.2</b> Contributors</a></li>
<li class="chapter" data-level="0.3" data-path="index.html"><a href="index.html#contributing"><i class="fa fa-check"></i><b>0.3</b> Contributing</a></li>
</ul></li>
<li class="part"><span><b>Linear mixed models (LMM) in <code>R</code></b></span></li>
<li class="chapter" data-level="1" data-path="learning-objectives.html"><a href="learning-objectives.html"><i class="fa fa-check"></i><b>1</b> Learning objectives</a></li>
<li class="chapter" data-level="2" data-path="preparing-for-the-workshop.html"><a href="preparing-for-the-workshop.html"><i class="fa fa-check"></i><b>2</b> Preparing for the workshop</a></li>
<li class="chapter" data-level="3" data-path="why-choose-mixed-models.html"><a href="why-choose-mixed-models.html"><i class="fa fa-check"></i><b>3</b> Why choose mixed models?</a></li>
<li class="chapter" data-level="4" data-path="starting-with-a-question.html"><a href="starting-with-a-question.html"><i class="fa fa-check"></i><b>4</b> Starting with a question</a><ul>
<li class="chapter" data-level="4.1" data-path="starting-with-a-question.html"><a href="starting-with-a-question.html#challenge-1"><i class="fa fa-check"></i><b>4.1</b> Challenge 1</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="analyzing-the-data.html"><a href="analyzing-the-data.html"><i class="fa fa-check"></i><b>5</b> Analyzing the data</a><ul>
<li class="chapter" data-level="5.1" data-path="analyzing-the-data.html"><a href="analyzing-the-data.html#separate"><i class="fa fa-check"></i><b>5.1</b> Separate</a></li>
<li class="chapter" data-level="5.2" data-path="analyzing-the-data.html"><a href="analyzing-the-data.html#lump"><i class="fa fa-check"></i><b>5.2</b> Lump</a></li>
<li class="chapter" data-level="5.3" data-path="analyzing-the-data.html"><a href="analyzing-the-data.html#is-there-a-third-option"><i class="fa fa-check"></i><b>5.3</b> Is there a third option?</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="fixed-vs-random-effects.html"><a href="fixed-vs-random-effects.html"><i class="fa fa-check"></i><b>6</b> Fixed vs. random effects</a><ul>
<li class="chapter" data-level="6.1" data-path="fixed-vs-random-effects.html"><a href="fixed-vs-random-effects.html#fixed-effects-deterministic-processes"><i class="fa fa-check"></i><b>6.1</b> Fixed effects: deterministic processes</a></li>
<li class="chapter" data-level="6.2" data-path="fixed-vs-random-effects.html"><a href="fixed-vs-random-effects.html#random-effects-stochastic-processes"><i class="fa fa-check"></i><b>6.2</b> Random effects: stochastic processes</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="how-do-lmms-work.html"><a href="how-do-lmms-work.html"><i class="fa fa-check"></i><b>7</b> How do LMMs work?</a><ul>
<li class="chapter" data-level="7.1" data-path="how-do-lmms-work.html"><a href="how-do-lmms-work.html#parameters-are-varied"><i class="fa fa-check"></i><b>7.1</b> Parameters are varied</a><ul>
<li class="chapter" data-level="" data-path="how-do-lmms-work.html"><a href="how-do-lmms-work.html#intercepts"><i class="fa fa-check"></i>Intercepts:</a></li>
<li class="chapter" data-level="" data-path="how-do-lmms-work.html"><a href="how-do-lmms-work.html#slopes"><i class="fa fa-check"></i>Slopes:</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="how-do-lmms-work.html"><a href="how-do-lmms-work.html#data-structure-is-taken-into-account"><i class="fa fa-check"></i><b>7.2</b> Data structure is taken into account</a></li>
<li class="chapter" data-level="7.3" data-path="how-do-lmms-work.html"><a href="how-do-lmms-work.html#challenge-2"><i class="fa fa-check"></i><b>7.3</b> Challenge 2</a></li>
</ul></li>
<li class="part"><span><b>Implementing LMM in <code>R</code></b></span></li>
<li class="chapter" data-level="8" data-path="mixed-model-protocol.html"><a href="mixed-model-protocol.html"><i class="fa fa-check"></i><b>8</b> Mixed model protocol</a><ul>
<li><a href="mixed-model-protocol.html#step-1.-a-priori-model-building">Step 1. <em>A priori</em> model building</a><ul>
<li class="chapter" data-level="" data-path="mixed-model-protocol.html"><a href="mixed-model-protocol.html#check-data-structure"><i class="fa fa-check"></i>Check data structure</a></li>
<li class="chapter" data-level="" data-path="mixed-model-protocol.html"><a href="mixed-model-protocol.html#check-collinearity"><i class="fa fa-check"></i>Check collinearity</a></li>
<li class="chapter" data-level="" data-path="mixed-model-protocol.html"><a href="mixed-model-protocol.html#challenge-3"><i class="fa fa-check"></i>Challenge 3</a></li>
<li class="chapter" data-level="" data-path="mixed-model-protocol.html"><a href="mixed-model-protocol.html#consider-scale"><i class="fa fa-check"></i>Consider scale</a></li>
<li class="chapter" data-level="" data-path="mixed-model-protocol.html"><a href="mixed-model-protocol.html#do-you-need-a-lmm"><i class="fa fa-check"></i>Do you need a LMM?</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="mixed-model-protocol.html"><a href="mixed-model-protocol.html#step-2.-code-potential-models-and-model-selection"><i class="fa fa-check"></i>Step 2. Code potential models and model selection</a><ul>
<li class="chapter" data-level="" data-path="mixed-model-protocol.html"><a href="mixed-model-protocol.html#estimation-methods"><i class="fa fa-check"></i>Estimation methods</a></li>
<li class="chapter" data-level="" data-path="mixed-model-protocol.html"><a href="mixed-model-protocol.html#different-model-structures"><i class="fa fa-check"></i>Different model structures</a></li>
<li class="chapter" data-level="" data-path="mixed-model-protocol.html"><a href="mixed-model-protocol.html#challenge-4"><i class="fa fa-check"></i>Challenge 4</a></li>
<li class="chapter" data-level="" data-path="mixed-model-protocol.html"><a href="mixed-model-protocol.html#challenge-5"><i class="fa fa-check"></i>Challenge 5</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="mixed-model-protocol.html"><a href="mixed-model-protocol.html#step-3.-model-validation"><i class="fa fa-check"></i>Step 3. Model validation</a><ul>
<li class="chapter" data-level="" data-path="mixed-model-protocol.html"><a href="mixed-model-protocol.html#check-the-homogeneity-of-the-variance"><i class="fa fa-check"></i>1. Check the homogeneity of the variance</a></li>
<li class="chapter" data-level="" data-path="mixed-model-protocol.html"><a href="mixed-model-protocol.html#check-the-independence-of-the-model-residuals-with-each-covariate"><i class="fa fa-check"></i>2. Check the independence of the model residuals with each covariate</a></li>
<li class="chapter" data-level="" data-path="mixed-model-protocol.html"><a href="mixed-model-protocol.html#check-the-normality-of-the-model-residuals"><i class="fa fa-check"></i>3. Check the normality of the model residuals</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="mixed-model-protocol.html"><a href="mixed-model-protocol.html#step-4.-interpretation-and-visualization"><i class="fa fa-check"></i>Step 4. Interpretation and visualization</a><ul>
<li class="chapter" data-level="" data-path="mixed-model-protocol.html"><a href="mixed-model-protocol.html#challenge-6"><i class="fa fa-check"></i>Challenge 6</a></li>
<li class="chapter" data-level="" data-path="mixed-model-protocol.html"><a href="mixed-model-protocol.html#challenge-7"><i class="fa fa-check"></i>Challenge 7</a></li>
<li class="chapter" data-level="" data-path="mixed-model-protocol.html"><a href="mixed-model-protocol.html#challenge-8"><i class="fa fa-check"></i>Challenge 8</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>Generalized linear mixed models (GLMM) in <code>R</code></b></span></li>
<li class="chapter" data-level="9" data-path="generalized-linear-mixed-models-glmms.html"><a href="generalized-linear-mixed-models-glmms.html"><i class="fa fa-check"></i><b>9</b> Generalized linear mixed models (GLMMs)</a></li>
<li class="chapter" data-level="10" data-path="structure-in-dataset.html"><a href="structure-in-dataset.html"><i class="fa fa-check"></i><b>10</b> Structure in dataset</a><ul>
<li class="chapter" data-level="10.1" data-path="structure-in-dataset.html"><a href="structure-in-dataset.html#poisson-glmm"><i class="fa fa-check"></i><b>10.1</b> Poisson GLMM</a></li>
<li class="chapter" data-level="10.2" data-path="structure-in-dataset.html"><a href="structure-in-dataset.html#negative-binomial-poisson-gamma-glmm"><i class="fa fa-check"></i><b>10.2</b> Negative binomial (Poisson-gamma) GLMM</a></li>
<li class="chapter" data-level="10.3" data-path="structure-in-dataset.html"><a href="structure-in-dataset.html#poisson-lognormal-glmm"><i class="fa fa-check"></i><b>10.3</b> Poisson-lognormal GLMM</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="random-intercepts.html"><a href="random-intercepts.html"><i class="fa fa-check"></i><b>11</b> Random intercepts</a><ul>
<li class="chapter" data-level="11.1" data-path="random-intercepts.html"><a href="random-intercepts.html#parameter-plots"><i class="fa fa-check"></i><b>11.1</b> Parameter plots</a></li>
<li class="chapter" data-level="11.2" data-path="random-intercepts.html"><a href="random-intercepts.html#random-intercept-plots"><i class="fa fa-check"></i><b>11.2</b> Random intercept plots</a></li>
<li class="chapter" data-level="11.3" data-path="random-intercepts.html"><a href="random-intercepts.html#random-slopes"><i class="fa fa-check"></i><b>11.3</b> Random slopes</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="final-model.html"><a href="final-model.html"><i class="fa fa-check"></i><b>12</b> Final model</a></li>
<li class="part"><span><b>Final considerations</b></span></li>
<li class="chapter" data-level="13" data-path="summary.html"><a href="summary.html"><i class="fa fa-check"></i><b>13</b> Summary</a></li>
<li class="chapter" data-level="14" data-path="additional-resources.html"><a href="additional-resources.html"><i class="fa fa-check"></i><b>14</b> Additional resources</a><ul>
<li class="chapter" data-level="14.1" data-path="additional-resources.html"><a href="additional-resources.html#lmm-textbooks"><i class="fa fa-check"></i><b>14.1</b> LMM Textbooks</a></li>
<li class="chapter" data-level="14.2" data-path="additional-resources.html"><a href="additional-resources.html#glmm-resources"><i class="fa fa-check"></i><b>14.2</b> GLMM resources</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i><b>15</b> References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/qcbsRworkshops" target="blank">QCBS R Workshop Series</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Workshop 7: Linear and generalized linear mixed models (LMM and GLMM)</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<!------------------------ Hero Image Container --------------------------> 

<head>
  <meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=10.0,initial-scale=1.0">
  <script src="https://kit.fontawesome.com/6a26f47516.js"></script>
  <script src="assets/qcbs-hideOutput.js"></script>
  <link href="assets/qcbs-style.css" rel="stylesheet">
</head>



<div class="hero-image-container"> 
  <img class= "hero-image" src="assets/images/jean-philippe-delberghe-75xPHEQBmvA-unsplash_hero_image.jpg">
</div>
<div id="structure-in-dataset" class="section level1">
<h1><span class="header-section-number">Chapter 10</span> Structure in dataset</h1>
<p>When we look at the interaction between nutrient and clipping across the
9 different populations, we note that there is a consistent nutrient e
ffect (higher baseline under the High nutrient treatment). The effect of
clipping is weaker, but in some populations we note a negative slope.</p>
<pre class="{.rsplus|}"><code>ggplot(dat.tf,aes(x=amd,y=log(total.fruits+1),colour=nutrient)) +
  geom_point() + 
  stat_summary(aes(x= as.numeric(amd)),fun.y=mean,geom=&quot;line&quot;) +
  theme_bw() + theme(panel.margin=unit(0,&quot;lines&quot;)) +
  scale_color_manual(values=c(&quot;#3B9AB2&quot;,&quot;#F21A00&quot;)) + # from Wes Anderson Zissou palette
  facet_wrap(~popu)</code></pre>
<p><img src="images//workshp_6_glmm_popu.png" class="align-center" width="600" /></p>
<p>A similar plot can be made for the 24 different genotypes (changing
facet_wrap(~gen)).<br />
==== Choosing an error distribution ====</p>
<p>The response variable is count data which suggests that a Poisson
distribution should be used. Recall that an important property of the
Poisson distribution is that the variance is equal to the mean. However,
as we will see below, the group variances increase with the mean much
more rapidly than expected under the Poisson distribution.</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="structure-in-dataset.html#cb65-1"></a><span class="co"># Create new variables that represents every combination</span></span>
<span id="cb65-2"><a href="structure-in-dataset.html#cb65-2"></a><span class="co"># nutrient x clipping x random factor</span></span>
<span id="cb65-3"><a href="structure-in-dataset.html#cb65-3"></a>dat.tf &lt;-<span class="st"> </span><span class="kw">within</span>(dat.tf, {</span>
<span id="cb65-4"><a href="structure-in-dataset.html#cb65-4"></a>    <span class="co"># genotype x nutrient x clipping</span></span>
<span id="cb65-5"><a href="structure-in-dataset.html#cb65-5"></a>    gna &lt;-<span class="st"> </span><span class="kw">interaction</span>(gen, nutrient, amd)</span>
<span id="cb65-6"><a href="structure-in-dataset.html#cb65-6"></a>    gna &lt;-<span class="st"> </span><span class="kw">reorder</span>(gna, total.fruits, mean)</span>
<span id="cb65-7"><a href="structure-in-dataset.html#cb65-7"></a>    <span class="co"># population x nutrient x clipping</span></span>
<span id="cb65-8"><a href="structure-in-dataset.html#cb65-8"></a>    pna &lt;-<span class="st"> </span><span class="kw">interaction</span>(popu, nutrient, amd)</span>
<span id="cb65-9"><a href="structure-in-dataset.html#cb65-9"></a>    pna &lt;-<span class="st"> </span><span class="kw">reorder</span>(pna, total.fruits, mean)</span>
<span id="cb65-10"><a href="structure-in-dataset.html#cb65-10"></a>})</span>
<span id="cb65-11"><a href="structure-in-dataset.html#cb65-11"></a></span>
<span id="cb65-12"><a href="structure-in-dataset.html#cb65-12"></a></span>
<span id="cb65-13"><a href="structure-in-dataset.html#cb65-13"></a><span class="co"># Boxplot of total fruits vs new variable (genotype x</span></span>
<span id="cb65-14"><a href="structure-in-dataset.html#cb65-14"></a><span class="co"># nutrient x clipping)</span></span>
<span id="cb65-15"><a href="structure-in-dataset.html#cb65-15"></a><span class="kw">ggplot</span>(<span class="dt">data =</span> dat.tf, <span class="kw">aes</span>(<span class="kw">factor</span>(<span class="dt">x =</span> gna), <span class="dt">y =</span> <span class="kw">log</span>(total.fruits <span class="op">+</span><span class="st"> </span></span>
<span id="cb65-16"><a href="structure-in-dataset.html#cb65-16"></a><span class="st">    </span><span class="dv">1</span>))) <span class="op">+</span><span class="st"> </span><span class="kw">geom_boxplot</span>(<span class="dt">colour =</span> <span class="st">&quot;skyblue2&quot;</span>, <span class="dt">outlier.shape =</span> <span class="dv">21</span>, </span>
<span id="cb65-17"><a href="structure-in-dataset.html#cb65-17"></a>    <span class="dt">outlier.colour =</span> <span class="st">&quot;skyblue2&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>() <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">axis.text.x =</span> <span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">90</span>)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb65-18"><a href="structure-in-dataset.html#cb65-18"></a><span class="st">    </span><span class="kw">stat_summary</span>(<span class="dt">fun.y =</span> mean, <span class="dt">geom =</span> <span class="st">&quot;point&quot;</span>, <span class="dt">colour =</span> <span class="st">&quot;red&quot;</span>)</span>
<span id="cb65-19"><a href="structure-in-dataset.html#cb65-19"></a></span>
<span id="cb65-20"><a href="structure-in-dataset.html#cb65-20"></a><span class="co"># Boxplot of total fruits vs new variable (population x</span></span>
<span id="cb65-21"><a href="structure-in-dataset.html#cb65-21"></a><span class="co"># nutrient x clipping)</span></span>
<span id="cb65-22"><a href="structure-in-dataset.html#cb65-22"></a><span class="kw">ggplot</span>(<span class="dt">data =</span> dat.tf, <span class="kw">aes</span>(<span class="kw">factor</span>(<span class="dt">x =</span> pna), <span class="dt">y =</span> <span class="kw">log</span>(total.fruits <span class="op">+</span><span class="st"> </span></span>
<span id="cb65-23"><a href="structure-in-dataset.html#cb65-23"></a><span class="st">    </span><span class="dv">1</span>))) <span class="op">+</span><span class="st"> </span><span class="kw">geom_boxplot</span>(<span class="dt">colour =</span> <span class="st">&quot;skyblue2&quot;</span>, <span class="dt">outlier.shape =</span> <span class="dv">21</span>, </span>
<span id="cb65-24"><a href="structure-in-dataset.html#cb65-24"></a>    <span class="dt">outlier.colour =</span> <span class="st">&quot;skyblue2&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>() <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">axis.text.x =</span> <span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">90</span>)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb65-25"><a href="structure-in-dataset.html#cb65-25"></a><span class="st">    </span><span class="kw">stat_summary</span>(<span class="dt">fun.y =</span> mean, <span class="dt">geom =</span> <span class="st">&quot;point&quot;</span>, <span class="dt">colour =</span> <span class="st">&quot;red&quot;</span>)</span></code></pre></div>
<p><img src="images/workshp_6_glmm_boxplot.png" class="align-center" width="750" />
<img src="images//workshop_6_glmm_boxplot_popu.png" class="align-center" width="750" /></p>
<p>As illustrated above, there is a large amount of heterogeneity among the
group variances even when the response variable is transformed. We also
note that some groups have a mean and variance of zero.</p>
<p>To determine <span class="underline">which distribution family to use</span>, we can run
a diagnostic plot of the group variances vs their respective means. We
provide an example below for the genotype x nutrient x clipping
grouping.</p>
<ol style="list-style-type: decimal">
<li>If we observe a linear relationship between the variance and the
mean with a slope = 1, then the <strong>Poisson</strong> family is appropriate,</li>
<li>If we observe a linear mean-variance relationship with a slope &gt; 1
(i.e. Var = φµ where φ &gt; 1), then the <strong>quasi-Poisson</strong> family (as
introduced above) should be applied,</li>
<li>Finally, a quadratic relationship between the variance and the mean
(i.e. Var = µ(1 + α</li>
</ol>
<p>) or µ(1 + µ/k)), is characteristic of overdispersed data that is driven
by an underlying heterogeneity among samples. In this case, the
<strong>negative binomial</strong> (Poisson-gamma) would be more appropriate.
<img src="images/worksp_6_error_dist.png" class="align-center" width="450" /></p>
<p>From the plot above we note that a linear quasi-Poisson may be better
than the negative binomial, but additional modelling is needed.</p>
<div id="poisson-glmm" class="section level2">
<h2><span class="header-section-number">10.1</span> Poisson GLMM</h2>
<p>Let’s build a GLMM using the <code>glmer</code> function of the <em>lme4</em> package.
This model has a random intercept for all genotype and population
treatments. We include the nuisance variables (rack and germination
method) as fixed effects. Given the mean-variance relationship from
above, we most likely will need a model with overdispersion, but let’s
start with a Poisson model.</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="structure-in-dataset.html#cb66-1"></a>mp1 &lt;-<span class="st"> </span><span class="kw">glmer</span>(total.fruits <span class="op">~</span><span class="st"> </span>nutrient <span class="op">*</span><span class="st"> </span>amd <span class="op">+</span><span class="st"> </span>rack <span class="op">+</span><span class="st"> </span>status <span class="op">+</span><span class="st"> </span></span>
<span id="cb66-2"><a href="structure-in-dataset.html#cb66-2"></a><span class="st">    </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>popu) <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>gen), <span class="dt">data =</span> dat.tf, <span class="dt">family =</span> <span class="st">&quot;poisson&quot;</span>)</span></code></pre></div>
<p>We can check for overdispersion using a function <code>overdisp_fun</code> provided
by <a href="http://www.cell.com/cms/attachment/601623/4742452/mmc1.pdf">Bolker et al.
(2011)</a>
which divides the Pearson residuals by the residual degrees of freedom
and tests whether these values differ significantly (i.e., whether the
ratio of residual deviance to residual df is significantly different
from 1). A low p-value indicates that the data are over dispersed (i.e.,
ratio is significantly different from 1).</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="structure-in-dataset.html#cb67-1"></a><span class="co"># Overdispersion?</span></span>
<span id="cb67-2"><a href="structure-in-dataset.html#cb67-2"></a><span class="kw">overdisp_fun</span>(mp1)</span>
<span id="cb67-3"><a href="structure-in-dataset.html#cb67-3"></a></span>
<span id="cb67-4"><a href="structure-in-dataset.html#cb67-4"></a><span class="co"># Or as above, we can approximate this by dividing the</span></span>
<span id="cb67-5"><a href="structure-in-dataset.html#cb67-5"></a><span class="co"># residual deviance by the residual df</span></span>
<span id="cb67-6"><a href="structure-in-dataset.html#cb67-6"></a><span class="kw">summary</span>(mp1)</span>
<span id="cb67-7"><a href="structure-in-dataset.html#cb67-7"></a><span class="co"># residual deviance = 18253.7 and resid df = 616</span></span></code></pre></div>
<p>The ratio is significantly greater than unity, so as expected, we need
to try a different distribution where the variance increases more
rapidly than the mean, such as the negative binomial.</p>
</div>
<div id="negative-binomial-poisson-gamma-glmm" class="section level2">
<h2><span class="header-section-number">10.2</span> Negative binomial (Poisson-gamma) GLMM</h2>
<p>Recall that the negative binomial (or Poisson-gamma) distribution meets
the assumption that the variance is <strong>proportional to the square of the
mean</strong>.</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="structure-in-dataset.html#cb68-1"></a><span class="co"># Note: This model converges well if you are running R</span></span>
<span id="cb68-2"><a href="structure-in-dataset.html#cb68-2"></a><span class="co"># version 3.0.2, but may not converge with later versions. If</span></span>
<span id="cb68-3"><a href="structure-in-dataset.html#cb68-3"></a><span class="co"># you are having convergence issues, please try with version</span></span>
<span id="cb68-4"><a href="structure-in-dataset.html#cb68-4"></a><span class="co"># 3.0.2.</span></span>
<span id="cb68-5"><a href="structure-in-dataset.html#cb68-5"></a></span>
<span id="cb68-6"><a href="structure-in-dataset.html#cb68-6"></a>mnb1 &lt;-<span class="st"> </span><span class="kw">glmer.nb</span>(total.fruits <span class="op">~</span><span class="st"> </span>nutrient <span class="op">*</span><span class="st"> </span>amd <span class="op">+</span><span class="st"> </span>rack <span class="op">+</span><span class="st"> </span>status <span class="op">+</span><span class="st"> </span></span>
<span id="cb68-7"><a href="structure-in-dataset.html#cb68-7"></a><span class="st">    </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>popu) <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>gen), <span class="dt">data =</span> dat.tf, <span class="dt">control =</span> <span class="kw">glmerControl</span>(<span class="dt">optimizer =</span> <span class="st">&quot;bobyqa&quot;</span>))</span>
<span id="cb68-8"><a href="structure-in-dataset.html#cb68-8"></a><span class="co"># Although beyond the scope of this workshop, the new</span></span>
<span id="cb68-9"><a href="structure-in-dataset.html#cb68-9"></a><span class="co"># &#39;control&#39; argument specifies the way we optimize the</span></span>
<span id="cb68-10"><a href="structure-in-dataset.html#cb68-10"></a><span class="co"># parameter values (i.e. by taking the derivative of a</span></span>
<span id="cb68-11"><a href="structure-in-dataset.html#cb68-11"></a><span class="co"># function or proceeding by iteration).  When taking the</span></span>
<span id="cb68-12"><a href="structure-in-dataset.html#cb68-12"></a><span class="co"># derivative is not possible, an iterative algorithm such as</span></span>
<span id="cb68-13"><a href="structure-in-dataset.html#cb68-13"></a><span class="co"># bobyqa (Bound Optimization BY Quadratic Approximation) is</span></span>
<span id="cb68-14"><a href="structure-in-dataset.html#cb68-14"></a><span class="co"># used.</span></span>
<span id="cb68-15"><a href="structure-in-dataset.html#cb68-15"></a></span>
<span id="cb68-16"><a href="structure-in-dataset.html#cb68-16"></a><span class="co"># Overdispersion?</span></span>
<span id="cb68-17"><a href="structure-in-dataset.html#cb68-17"></a><span class="kw">overdisp_fun</span>(mnb1)</span></code></pre></div>
<p>The ratio is now much closer to unity (although the p-value is still
less than 0.05).</p>
</div>
<div id="poisson-lognormal-glmm" class="section level2">
<h2><span class="header-section-number">10.3</span> Poisson-lognormal GLMM</h2>
<p>Another option that we have not yet seen is to use a Poisson-lognormal
distribution. This approach deals with overdispersion by implementing an
observation-level random effects (OLRE; see <a href="https://peerj.com/articles/616.pdf">Harrison
(2014)</a>), which model the
extra-Poisson variation in the response variable using a random effect
with a unique level for every data point.</p>
<p>A Poisson-lognormal model effectively places a lognormal prior on ε<sub>i</sub>.
A Poisson-lognormal distribution with mean µ and lognormal prior
variance σ<sup>2</sup> has variance:</p>
<p>var(y) = µ + µ<sup>2</sup> <span class="math display">\[exp(σ^2^) - 1\]</span></p>
<p>In contrast, for the negative binomial, we saw that the distribution was
given by:</p>
<p>var(y) = µ + µ<sup>2</sup>/k</p>
<p>More generally, the variance term σ<sup>2</sup> in the Poisson-lognormal
distribution will depend on the grouping level we select (e.g., at the
individual, genotype or population level). That is, the
Poisson-lognormal model can allow for a more flexible approach to
assigning the observed aggregation to different sources of
heterogeneity. Here, to implement the observation-level random effect,
we will evaluate it at the individual level.</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="structure-in-dataset.html#cb69-1"></a>mpl1 &lt;-<span class="st"> </span><span class="kw">glmer</span>(total.fruits <span class="op">~</span><span class="st"> </span>nutrient <span class="op">*</span><span class="st"> </span>amd <span class="op">+</span><span class="st"> </span>rack <span class="op">+</span><span class="st"> </span>status <span class="op">+</span><span class="st"> </span></span>
<span id="cb69-2"><a href="structure-in-dataset.html#cb69-2"></a><span class="st">    </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>X) <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>popu) <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>gen), <span class="dt">data =</span> dat.tf, <span class="dt">family =</span> <span class="st">&quot;poisson&quot;</span>, </span>
<span id="cb69-3"><a href="structure-in-dataset.html#cb69-3"></a>    <span class="dt">control =</span> <span class="kw">glmerControl</span>(<span class="dt">optimizer =</span> <span class="st">&quot;bobyqa&quot;</span>))</span>
<span id="cb69-4"><a href="structure-in-dataset.html#cb69-4"></a></span>
<span id="cb69-5"><a href="structure-in-dataset.html#cb69-5"></a><span class="kw">overdisp_fun</span>(mpl1)</span></code></pre></div>
<p>We did it! The ratio between residual deviance and residual df now meets
our criterion (in fact, it is even <em>smaller</em> 1).</p>

</div>
</div>
<hr>
<center> 
  <div class="footer">
      All the content of the workshop series is under a <a href="https://creativecommons.org/licenses/by-nc/2.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.
  </div>
</center>
            </section>

          </div>
        </div>
      </div>
<a href="generalized-linear-mixed-models-glmms.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="random-intercepts.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": false
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
